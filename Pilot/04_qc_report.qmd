---
title: "Quality Check Report: `r params$indicator_name`"
format: 
  html:
    toc: true
    toc_float: true
    code_folding: show
    theme: cosmo
params:
  indicator_id: 1754
  indicator_name: "Indicator Name"
  data_source: "Data Source"
  comp_data_path: "Data/Checks/comp_id1754.csv"
execute:
  echo: false
  warning: false
  message: false
---

<!--
This report summarizes the quality checks performed to validate updated internal data for environmental indicators.
It compares internal data with the publicly available CEPALSTAT dataset to assess completeness, consistency, and statistical plausibility.
Non-technical readers are encouraged to read the section summaries for guidance on how to interpret results.
-->

```{r setup}
library(tidyverse)
library(magrittr)
library(readxl)
library(glue)
library(knitr)
library(gt)
library(reactable)
library(plotly)
library(scales)
library(lubridate)
library(DT)
library(scales)

# Load data
indicator_id <- params$indicator_id
comp <- read_csv(params$comp_data_path)
countries <- read_csv("../Data/iso_codes.csv")

# Metadata
date_stamp <- Sys.Date()
indicator_name <- params$indicator_name
data_source <- params$data_source

# Create summary info
summary_info <- list(
  "Report Date" = format(date_stamp, "%d %B %Y"),
  "Indicator ID" = indicator_id,
  "Indicator Name" = indicator_name,
  "Data Source" = data_source,
  "Time Coverage" = paste(min(comp$dim_29117_label), "-", max(comp$dim_29117_label)),
  "Number of Countries" = n_distinct(comp$dim_208_label),
  "Total Records" = nrow(comp)
)
```

## Executive Summary

This section summarizes key metadata about the indicator and dataset under review.
It helps contextualize the scope of the data quality checks.

```{r}
# Create summary table
summary_df <- tibble(
  Metric = names(summary_info),
  Value = unlist(summary_info)
)

summary_df %>%
  gt() %>%
  tab_header(
    title = "QC Report Information",
    subtitle = glue("Generated on {format(date_stamp, '%d %B %Y')}")
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "#f7f7f7"),
      cell_text(weight = "bold")
    ),
    locations = cells_column_labels()
  )
```

## Completeness Check

### Data Completeness by Country and Year

This section verifies whether the internal dataset covers the same country-year combinations as the public CEPALSTAT version. 
It flags:
- "Missing in Both" (no data in either source)
- "Old Only" (data was removed or lost in the new version)
- "New Only" (new values added that were not in the original public version)
- "Present in Both" (overlap between datasets)

The visual below shows data coverage by country and year. Gaps or additions should be reviewed for justification.


```{r}
all_combinations <- expand_grid(
  country = countries$name[which(countries$ECLAC == "Y")],
  year = min(comp$dim_29117_label):max(comp$dim_29117_label)
)

coverage_check <- all_combinations %>%
  left_join(comp, by = c("country" = "dim_208_label", "year" = "dim_29117_label")) %>% 
  mutate(status = ifelse(is.na(status), "Missing in Both", status))

# Remove sub-regions if not in data set
regional_status <- coverage_check$status[which(coverage_check$country %in% c("Latin America", "Caribbean", "South America", "Central America"))]

if(all(regional_status == "Missing in Both")) {
  coverage_check %<>%
    filter(!country %in% c("Latin America", "Caribbean", "South America", "Central America"))
}

```

```{r}
p <- coverage_check %>% 
  mutate(
    country = factor(country, levels = sort(unique(country), decreasing = TRUE)),
    status = factor(status, 
                   levels = c("Present in Both", "New Only", "Old Only", "Missing in Both"),
                   labels = c("Present in Both", "New Only", "Old Only", "Missing in Both"))
  ) %>% 
  ggplot(aes(x = year, y = country, fill = status,
             text = paste("Country:", country, 
                         "<br>Year:", year, 
                         "<br>Status:", status))) +
  geom_tile(color = "white") +
  scale_fill_manual(values = c(
    "Missing in Both" = "white",
    "Old Only" = "#ff9999",
    "New Only" = "#99ccff",
    "Present in Both" = "#e6e6e6"
  )) +
  labs(
    title = "Data Availability by Country and Year",
    subtitle = "Shows data availability in both internal and public datasets",
    x = NULL, 
    y = NULL, 
    fill = "Data Coverage"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 12),
    legend.position = "bottom",
    legend.title = element_text(face = "bold")
  )

ggplotly(p, tooltip = "text") %>%
  layout(
    legend = list(orientation = "h", y = -0.2)
  )
```


**Add check for missing records when there are additional dimensions

Insert line plots with old data in black and new data points in blue?

## Change Detection

This section analyzes changes between values that are available in both the public and internal data sets.
Key statistics include mean and absolute differences, and the share of values with changes greater than ±20%.
Red dots in the plots identify values that exceed this threshold.
This helps identify outliers, input errors, or significant data revisions that may need explanation.

### Summary Statistics

```{r}
summary_info <- comp %>%
  filter(status == "Present in Both") %>%
  summarise(
    "Mean % difference" = round(mean(perc_diff, na.rm = TRUE), 1),
    "% of values with large differences (<20%)" = round(mean(flag_large_diff, na.rm = TRUE) * 100, 1),
    "Mean absolute difference" = round(mean(abs_diff, na.rm = TRUE), 1),
    "Median reported value" = round(median(value_data, na.rm = TRUE), 1),
    "Minimum reported value" = round(min(value_data, na.rm = TRUE), 1),
    "Maximum reported value" = round(max(value_data, na.rm = TRUE), 1)
  )

# Convert to long format
summary_df <- tibble(
  Metric = names(summary_info),
  Value = unlist(summary_info)
)

# Format with % where applicable
summary_df <- summary_df %>%
  mutate(
    Value = case_when(
      grepl("%", Metric) ~ percent(as.numeric(Value) / 100, accuracy = 0.1),
      TRUE ~ as.character(Value)
    )
  )

# Render with gt
summary_df %>%
  gt() %>%
  tab_header(
    title = "Change Detection Summary",
    subtitle = "Key metrics comparing values present in both internal and public datasets"
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "#f7f7f7"),
      cell_text(weight = "bold")
    ),
    locations = cells_column_labels()
  )
```


### Relative Difference Comparison

```{r}
(ggplot(comp %>% filter(flag_some_na == FALSE), aes(
  x = as.numeric(dim_29117_label),
  y = perc_diff,
  text = paste("Record ID:", record_id,
               "<br>Country:", dim_208_label,
               "<br>Year:", dim_29117_label,
               "<br>% Diff:", perc_diff)
)) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -0.2, ymax = 0.2, alpha = 0.1, fill = "blue") +
  geom_hline(yintercept = c(-20, 20), color = "gray60", linetype = "dashed") +
  geom_point(aes(color = abs(perc_diff) > 20), alpha = 0.7) +
  scale_color_manual(values = c("FALSE" = "black", "TRUE" = "red"), guide = "none") +
  labs(title = "Percent Difference by Year",
       subtitle = "Red points are outside of the ±20% tolerance threshold",
       x = "Year",
       y = "Percent Difference") +
  theme_minimal() +
  theme(legend.position = "none")
) %>%
  ggplotly(tooltip = "text") %>%
  layout(
    title = list(
      text = paste0(
        "Percent Difference (%) by Year",
        '<br><sup>Red points are outside of the ±20% tolerance threshold</sup>'
      )
    )
  )
```

### Absolute Difference Comparison

```{r}
# Create static ggplot
p <- ggplot(comp, aes(x = value_pub, y = value_data,
                      text = paste("Record ID:", record_id,
                                   "<br>Country:", dim_208_label,
                                   "<br>Year:", dim_29117_label,
                                   "<br>Public:", value_pub,
                                   "<br>Internal:", value_data))) +
  geom_point(alpha = 0.6) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(x = "Public Data", y = "Internal Data", title = "Value Comparison")

# Convert to interactive plot with tooltips
ggplotly(p, tooltip = "text")
```



### Above Threshold Table

This is a list of records with more than a 20% difference between the updated internal and public CEPALSTAT data.

```{r}
reactable(
  comp %>%
    filter(flag_large_diff == TRUE) %>%
    select(record_id, ends_with("label"), value_data, value_pub, perc_diff) %>% 
    mutate(value_data = round(value_data, 1), value_pub = round(value_pub, 1)),
  defaultPageSize = 5,
  searchable = TRUE,
  highlight = TRUE,
  bordered = TRUE,
  theme = reactableTheme(
    style = list(fontFamily = "Segoe UI, Roboto, Helvetica, sans-serif", fontSize = "14px")
  )
)
```

## Outlier Detection

This section provides statistical outlier detection based on z-scores.
It flags any records where the percent difference is more than 3 standard deviations from the mean. 
These could indicate outliers or extreme changes in the data.

```{r}
## Run z-score tests

# Calculate z score based on percent difference between current and public
tests <- comp %>% 
  filter(flag_some_na == FALSE) %>% 
  mutate(z_perc = scale(perc_diff),
         outlier_perc = ifelse(abs(z_perc) > 3, TRUE, FALSE))

# Table of flagged outliers
comp %>% 
  filter(flag_some_na == FALSE) %>% 
  mutate(z_perc = round(scale(perc_diff), 1),
         outlier_perc = ifelse(abs(z_perc) > 3, TRUE, FALSE),
         value_data = round(value_data, 1), value_pub = round(value_pub, 1)) %>%
  filter(outlier_perc == TRUE) %>%
  select(record_id, dim_208_label, dim_29117_label, value_data, value_pub, perc_diff, z_perc) %>%
  arrange(desc(abs(z_perc))) %>%
  reactable(
    defaultPageSize = 10,
    bordered = TRUE,
    highlight = TRUE,
    theme = reactableTheme(
      style = list(fontFamily = "Segoe UI, Roboto, Helvetica, sans-serif", fontSize = "14px")
    )
  )
```


#### Country-level analysis

(To be refined further with more examples.)

Country time series:

```{r}
p <- ggplot(comp, aes(
  x = as.numeric(dim_29117_label),
  y = value_data,
  group = dim_208_label,
  color = dim_208_label,  # for visual separation
  text = paste("Country:", dim_208_label,
               "<br>Year:", dim_29117_label,
               "<br>Value:", round(value_data, 2))
)) +
  geom_line(alpha = 0.7) +
  scale_color_viridis_d(option = "D") +
  labs(
    title = "Country Time Series – Internal Data",
    x = "Year", y = "Value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")  # hide legend

# Convert to interactive plot
ggplotly(p, tooltip = "text")
```

```{r}
library(ggplot2)
library(plotly)

# Base ggplot
p <- ggplot(comp, aes(
  x = as.numeric(dim_29117_label),  # Year
  y = value_data,
  group = dim_208_label,            # Country
  color = flag_new_entry,
  text = paste(
    "Country:", dim_208_label,
    "<br>Year:", dim_29117_label,
    "<br>Value:", round(value_data, 1),
    "<br>New entry:", flag_new_entry
  )
)) +
  geom_line(aes(group = dim_208_label), alpha = 0.5, color = "gray50") +
  geom_point(size = 1, alpha = 0.7) +
  scale_color_manual(values = c("FALSE" = "black", "TRUE" = "red")) +
  labs(
    title = "Time Series by Country",
    subtitle = "Red points indicate new entries not present in public dataset",
    x = "Year",
    y = "Value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

# Convert to interactive plot
ggplotly(p, tooltip = "text")

```


```{r}
library(ggplot2)
library(plotly)

p2 <- ggplot(comp, aes(
  x = as.numeric(dim_29117_label),  # Year
  y = value_data,
  group = dim_208_label,            # Country
  color = flag_large_diff,
  text = paste(
    "Country:", dim_208_label,
    "<br>Year:", dim_29117_label,
    "<br>Value:", round(value_data, 1),
    "<br>% Difference:", round(perc_diff, 1),
    "<br>Above Threshold:", flag_large_diff
  )
)) +
  geom_line(aes(group = dim_208_label), alpha = 0.5, color = "gray50") +
  geom_point(size = 2, alpha = 0.9) +
  scale_color_manual(values = c("FALSE" = "black", "TRUE" = "red")) +
  labs(
    title = "Time Series by Country",
    subtitle = "Red points indicate values with >20% difference from public data",
    x = "Year",
    y = "Internal Value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

ggplotly(p2, tooltip = "text")

```


```{r}
library(dplyr)
library(ggplot2)
library(plotly)

# Step 1: Identify countries with at least one large difference
countries_with_flags <- comp %>%
  filter(flag_large_diff == TRUE) %>%
  distinct(dim_208_label) %>%
  pull()

# Step 2: Filter full dataset to only include those countries
comp_flagged <- comp %>%
  filter(dim_208_label %in% countries_with_flags)

# Step 3: Create the plot
p3 <- ggplot(comp_flagged, aes(
  x = as.numeric(dim_29117_label),  # Year
  y = value_data,
  group = dim_208_label,
  color = flag_large_diff,
  text = paste(
    "Country:", dim_208_label,
    "<br>Year:", dim_29117_label,
    "<br>Value:", round(value_data, 1),
    "<br>% Difference:", round(perc_diff, 1),
    "<br>Above Threshold:", flag_large_diff
  )
)) +
  geom_line(aes(group = dim_208_label), alpha = 0.5, color = "gray50") +
  geom_point(size = 2, alpha = 0.9) +
  scale_color_manual(values = c("FALSE" = "black", "TRUE" = "red")) +
  labs(
    title = "Countries with at Least One Large Difference",
    subtitle = "Only countries with at least one value >20% difference are shown",
    x = "Year",
    y = "Internal Value"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

ggplotly(p3, tooltip = "text")

```



## Appendix

### Data Dictionary

```{r}
# Create data dictionary
data_dict <- tibble(
  Field = names(comp),
  Description = c(
    "Unique record identifier",
    "Country code",
    "Country name",
    "Year code",
    "Year name",
    "Value in internal dataset",
    "Value in public dataset",
    "Absolute difference between values",
    "Percent difference between values",
    "Flag for missing entries",
    "Flag for new entries",
    "Flag for large differences",
    "Flag for NA values",
    "Comparison status"
  )
)

data_dict %>%
  gt() %>%
  tab_header(
    title = "Data Dictionary",
    subtitle = "Description of fields in the comparison dataset"
  )
```

### Technical Details

```{r}
# Session information
sessionInfo()
```
